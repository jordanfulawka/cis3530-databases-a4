{% extends "base.html" %} {% block title %}Employees{% endblock %} {% block
content %}
<h1>Employee Overview</h1>

<form method="GET" action="{{ url_for('employees') }}" class="filter-form">
  <label for="department">Department:</label>
  <select name="department" id="department">
    <option value="">All</option>
    {% for dept in departments %}
      <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
    {% endfor %}
  </select>

  <label for="name">Employee Name:</label>
  <input type="text" name="name" id="name" value="{{ name_filter }}">

  <label for="sort_by">Sort by:</label>
  <select name="sort_by" id="sort_by">
    <option value="name" {% if request.args.get('sort_by') == 'name' %}selected{% endif %}>Name</option>
    <option value="total_hours" {% if request.args.get('sort_by') == 'total_hours' %}selected{% endif %}>Total Hours</option>
  </select>

  <label for="sort_dir">Direction:</label>
  <select name="sort_dir" id="sort_dir">
    <option value="asc" {% if request.args.get('sort_dir') == 'asc' %}selected{% endif %}>Ascending</option>
    <option value="desc" {% if request.args.get('sort_dir') == 'desc' %}selected{% endif %}>Descending</option>
  </select>

  <button type="submit">Filter</button>
  <button type="button" onclick="exportTableToCSV('employees_export.csv')">Export Table to CSV</button>
</form>
<form class="filter-form">
  <button type="submit">Clear Filters</button>
</form>
{% if g.user.role == 'admin' %}
<form action="{{ url_for('import_employees') }}" method="POST" enctype="multipart/form-data">
    <input type="file" name="file" accept=".xlsx" required>
    <button type="submit" class="btn btn-primary">Import from Excel</button>
    <a href="{{ url_for('download_template') }}" class="button-link" style="background-color: blue;">Download Excel Template</a>
</form>
{% endif %}

<table border="1" id="employeesTable">
  <thead>
    <tr>
      <th>Employee Name</th>
      <th>Department</th>
      <th># of Dependents</th>
      <th># of Projects</th>
      <th>Total Hours</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for emp in employees %}
    <tr>
      <td>{{ emp['fname'] }} {{ emp['minit'] }} {{ emp['lname'] }}</td>
      <td>{{ emp['department_name'] }}</td>
      <td>{{ emp['num_dependents'] }}</td>
      <td>{{ emp['num_projects'] }}</td>
      <td>{{ emp['total_hours'] }}</td>
      {% if g.user.role == 'admin' %}
      <td>
        <!-- <a href="{{ url_for('edit_employee_form', ssn=emp['ssn']) }}">Edit</a> -->
         <form action="{{ url_for('edit_employee_form', ssn=emp['ssn']) }}" method="GET" style="display:inline">
          <button type="submit">Edit</button>
         </form>
        <form
          action="{{ url_for('delete_employee', ssn=emp['ssn']) }}"
          method="POST"
          style="display: inline"
        >
          <button
            type="submit"
            style="background-color: red"
            onclick="return confirm('Are you sure you want to delete this employee?')"
          >
            Delete
          </button>
        </form>
      </td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  function downloadCSV(csv, filename) {
    const csvFile = new Blob([csv], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.download = filename;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
  }

  function exportTableToCSV(filename) {
    const rows = document.querySelectorAll('#employeesTable tr');
    let csv = [];

    for (let i = 0; i < rows.length; i++) {
      let row = [], cols = rows[i].querySelectorAll('td, th');
      for (let j = 0; j < cols.length-1; j++) {
        row.push(cols[j].innerText);
      }
      csv.push(row.join(','));
    }

    downloadCSV(csv.join('\n'), filename);
  }
</script>


{% endblock %}