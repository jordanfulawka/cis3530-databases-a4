{% extends "base.html" %} {% block title %}Employees{% endblock %} {% block
content %}
<h1>Employee Overview</h1>

<form method="GET" action="{{ url_for('employees') }}" class="filter-form">
  <label for="department">Department:</label>
  <select name="department" id="department">
    <option value="">All</option>
    {% for dept in departments %}
      <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
    {% endfor %}
  </select>

  <label for="name">Employee Name:</label>
  <input type="text" name="name" id="name" value="{{ name_filter }}">

  <label for="sort_by">Sort by:</label>
  <select name="sort_by" id="sort_by">
    <option value="name" {% if request.args.get('sort_by') == 'name' %}selected{% endif %}>Name</option>
    <option value="total_hours" {% if request.args.get('sort_by') == 'total_hours' %}selected{% endif %}>Total Hours</option>
  </select>

  <label for="sort_dir">Direction:</label>
  <select name="sort_dir" id="sort_dir">
    <option value="asc" {% if request.args.get('sort_dir') == 'asc' %}selected{% endif %}>Ascending</option>
    <option value="desc" {% if request.args.get('sort_dir') == 'desc' %}selected{% endif %}>Descending</option>
  </select>

  <button type="submit">Filter</button>
  <button type="submit">Clear Filters</button>
  <button type="button" onclick="exportTableToCSV('employees_export.csv')">Export Table to CSV</button>
</form>

<table border="1" id="employeesTable">
  <thead>
    <tr>
      <th>Employee Name</th>
      <th>Department</th>
      <th># of Dependents</th>
      <th># of Projects</th>
      <th>Total Hours</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for emp in employees %}
    <tr>
      <td>{{ emp['fname'] }} {{ emp['minit'] }} {{ emp['lname'] }}</td>
      <td>{{ emp['department_name'] }}</td>
      <td>{{ emp['num_dependents'] }}</td>
      <td>{{ emp['num_projects'] }}</td>
      <td>{{ emp['total_hours'] }}</td>
      <td>
        <a href="{{ url_for('edit_employee_form', ssn=emp['ssn']) }}">Edit</a>
        <form
          action="{{ url_for('delete_employee', ssn=emp['ssn']) }}"
          method="POST"
          style="display: inline"
        >
          <button
            type="submit"
            onclick="return confirm('Are you sure you want to delete this employee?')"
          >
            Delete
          </button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  function downloadCSV(csv, filename) {
    const csvFile = new Blob([csv], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.download = filename;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
  }

  function exportTableToCSV(filename) {
    const rows = document.querySelectorAll('#employeesTable tr');
    let csv = [];

    for (let i = 0; i < rows.length; i++) {
      let row = [], cols = rows[i].querySelectorAll('td, th');
      for (let j = 0; j < cols.length-1; j++) {
        row.push(cols[j].innerText);
      }
      csv.push(row.join(','));
    }

    downloadCSV(csv.join('\n'), filename);
  }
</script>

<style>
  .filter-form {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
  }

  .filter-form label {
    font-weight: 600;
  }

  .filter-form input,
  .filter-form select {
    padding: 5px 10px;
    border-radius: 3px;
    border: 1px solid #ccc;
  }

  .filter-form button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    background-color: #002fffff;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  .filter-form button:hover {
    background-color: #003a79ff;
  }
</style>

{% endblock %}